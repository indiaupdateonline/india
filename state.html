<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title id="title">State — Current Affairs</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <div class="container">
    <p><a href="/">← Back to States</a></p>
    <header id="stateHeader"></header>

    <div class="controls">
      <input id="q" class="search" placeholder="Search headlines..." />
      <select id="filterCategory"><option value="">All categories</option></select>
    </div>

    <main id="newsList"></main>
    <p id="noMore" style="display:none">No more updates.</p>
  </div>

  <script type="module">
    import { supabase } from '/assets/js/supabase-client.js';

    const params = new URLSearchParams(location.search);
    const stateName = params.get('name');
    if (!stateName) {
      document.getElementById('stateHeader').innerText = 'State not specified';
      throw new Error('state name required');
    }

    document.getElementById('title').innerText = `${stateName} — Current Affairs`;

    async function loadHeader() {
      const { data } = await supabase.from('states').select('*').eq('name_en', stateName).limit(1);
      if (!data || data.length===0) return;
      const s = data[0];
      const header = document.getElementById('stateHeader');
      header.innerHTML = `<h2>${s.name_hi || s.name_en}</h2>`;
      if (s.map_path) {
        const { data: urlData } = supabase.storage.from('maps').getPublicUrl(s.map_path);
        const imgUrl = urlData?.publicUrl || '';
        if (imgUrl) header.innerHTML += `<div class="map-thumb"><img src="${imgUrl}" alt="${s.name_en} map"></div>`;
      }
    }

    let page = 0, perPage = 8;

    async function loadNews() {
      const from = page*perPage, to = from + perPage -1;
      const { data, error } = await supabase
        .from('current_affairs')
        .select('*')
        .eq('state_name', stateName)
        .order('published_date', { ascending:false })
        .range(from,to);

      if (error) { console.error(error); return; }
      if (!data || data.length===0) {
        if (page===0) document.getElementById('newsList').innerHTML = '<p>No updates yet for this state.</p>';
        document.getElementById('noMore').style.display = 'block';
        return;
      }
      render(data);
      page++;
    }

    function render(rows) {
      const list = document.getElementById('newsList');
      for (const r of rows) {
        const el = document.createElement('article'); el.className='news-item';
        el.innerHTML = `
          <h3>${r.headline}</h3>
          <p class="meta">${new Date(r.published_date).toLocaleDateString()}</p>
          <p>${r.details || ''}</p>
        `;
        list.appendChild(el);
      }
    }

    document.getElementById('q').addEventListener('input', async (e) => {
      const q = e.target.value.trim();
      if (!q) { document.getElementById('newsList').innerHTML=''; page=0; await loadNews(); return; }
      const { data } = await supabase.from('current_affairs').select('*').ilike('headline', `%${q}%`).eq('state_name', stateName).order('published_date', { ascending:false }).limit(50);
      document.getElementById('newsList').innerHTML = '';
      render(data || []);
    });

    // initial
    await loadHeader();
    await loadNews();

    // infinite-scroll-ish: load more on scroll bottom
    window.addEventListener('scroll', () => {
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 180) {
        loadNews();
      }
    });
  </script>
</body>
</html>