<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Periods — Indian Literature Archive</title>
  <meta name="description" content="Explore Indian literature by historical period. Interactive filters, charts, pagination and data management (periods.json)." />
  <!-- Site fonts & icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Noto+Serif:400,700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <!-- Minimal CSS that preserves original site look but is fully responsive -->
  <style>
    :root {
      --accent:#0b6b6b;
      --dark:#0b2b3a;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f7fafc;
      --radius:10px;
      --max-width:1150px;
      --gutter:18px;
      font-family: "Noto Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color-scheme: light;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0b2b3a;}
    a{color:var(--accent);text-decoration:none;}
    .container{max-width:var(--max-width);margin:0 auto;padding:18px;}
    /* Header */
    .announcement-bar{background:#0b2b3a;color:#fff;padding:8px 0;font-size:14px;}
    .announcement-bar .container{display:flex;justify-content:space-between;align-items:center;gap:12px;}
    header.site-header{background:#0b2b3a;color:#fff;padding:12px 0;}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .branding{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit;}
    .logo-symbol{width:44px;height:44px;border-radius:6px;background:#fff;color:var(--dark);display:flex;align-items:center;justify-content:center;font-weight:700;}
    .site-title{margin:0;font-size:16px;font-weight:700;}
    .site-tagline{margin:0;font-size:12px;color:#cfe7e7;}
    /* Nav */
    nav.main-navigation{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    nav.main-navigation a{color:#fff;padding:8px 10px;border-radius:6px;font-weight:600;}
    /* Mobile menu */
    .mobile-toggle{display:none;background:transparent;border:1px solid rgba(255,255,255,0.12);padding:6px;border-radius:8px;color:#fff;}
    /* Hero */
    .hero{background-image:linear-gradient(180deg, rgba(11,43,58,0.95), rgba(11,43,58,0.75));color:#fff;padding:28px 0;margin-bottom:12px;}
    .hero .hero-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .hero h1{margin:0;font-size:22px;}
    .hero p{margin:6px 0;color:#d6f0f0;}
    /* Main layout responsive */
    main#main-content{padding-bottom:40px;}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start;}
    /* On small screens stack */
    @media (max-width:980px){
      .layout{grid-template-columns:1fr;}
      nav.main-navigation{display:none;}
      .mobile-toggle{display:inline-block;}
    }

    /* Cards & controls */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 18px rgba(11,43,58,0.06);padding:14px;border:1px solid #e6eef0;}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;}
    .controls input[type="search"], .controls select {padding:8px 10px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;font-size:14px;min-width:120px;}
    .controls .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;}
    .muted{color:var(--muted);font-size:13px;}
    .period-card{display:block;margin-bottom:12px;padding:14px;border-left:6px solid var(--accent);cursor:pointer;}
    .period-title{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .period-title h3{margin:0;font-size:18px;}
    .period-meta{font-size:13px;color:var(--muted);}
    .period-tags{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;}
    .tag{background:#e6f6f6;color:var(--accent);padding:5px 8px;border-radius:999px;font-weight:600;font-size:12px;}

    /* Table & small lists */
    table{width:100%;border-collapse:collapse;margin-top:10px;border-radius:6px;overflow:hidden;}
    th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px;}
    th{background:#f8fafc;font-weight:700;color:var(--dark);}

    /* Pagination */
    .pagination{display:flex;gap:8px;align-items:center;justify-content:center;padding:12px 0;flex-wrap:wrap;}
    .pagination button{padding:8px 10px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;}
    .pagination button.active{background:var(--accent);color:#fff;border-color:var(--accent);}

    /* Detail panel */
    .detail-heading{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .detail-content{margin-top:10px;font-size:14px;}
    .list-compact{list-style:none;padding-left:0;margin:0;display:flex;flex-direction:column;gap:6px;}
    .small-muted{font-size:13px;color:var(--muted);}

    /* Charts responsive */
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
    @media (max-width:640px){ .charts-grid{grid-template-columns:1fr;} }

    /* Add / export form */
    .form-row{display:flex;gap:8px;flex-wrap:wrap;}
    .form-row input, .form-row textarea, .form-row select {width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;}
    .btn-ghost{background:transparent;border:1px solid #e6eef0;padding:8px;border-radius:8px;cursor:pointer;}

    footer.site-footer{background:var(--dark);color:#fff;padding:18px 0;margin-top:24px;}
    footer .footer-inner{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;}
    footer a{color:#fff;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
  </style>
</head>
<body>

  <!-- Skip link -->
  <a class="sr-only" href="#main-content">Skip to main content</a>

  <!-- Announcement -->
  <div class="announcement-bar" role="region" aria-label="Announcement bar">
    <div class="container">
      <div>New: Complete translations of <em>Silappadikaram</em> now available!</div>
      <div class="muted">Explore the Medieval Tamil corpus</div>
    </div>
  </div>

  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <a class="branding" href="/" aria-label="Indian Literature Archive home">
        <div class="logo-symbol" aria-hidden="true">IA</div>
        <div>
          <div class="site-title">Indian Literature Archive</div>
          <div class="site-tagline">Ancient &amp; Medieval Texts</div>
        </div>
      </a>

      <nav class="main-navigation" role="navigation" aria-label="Main Navigation">
        <a href="/">Home</a>
        <a href="/languages">Languages</a>
        <a href="/periods" aria-current="page">Periods</a>
        <a href="/genres">Genres</a>
        <a href="/resources">Resources</a>
        <a href="/about">About</a>
      </nav>

      <!-- Mobile menu toggle -->
      <button class="mobile-toggle" id="mobileToggle" aria-expanded="false" aria-controls="mobileMenu">Menu</button>
    </div>
  </header>

  <!-- Mobile menu panel (hidden on desktop) -->
  <div id="mobileMenu" style="display:none;background:var(--dark);color:#fff;padding:12px;">
    <div class="container" style="display:flex;flex-direction:column;gap:8px;">
      <a href="/" style="color:#fff;">Home</a>
      <a href="/languages" style="color:#fff;">Languages</a>
      <a href="/periods" style="color:#fff;">Periods</a>
      <a href="/genres" style="color:#fff;">Genres</a>
      <a href="/resources" style="color:#fff;">Resources</a>
      <a href="/about" style="color:#fff;">About</a>
    </div>
  </div>

  <!-- Hero -->
  <section class="hero" role="region" aria-label="Hero">
    <div class="container hero-inner">
      <div>
        <h1>Discover India's Literary Heritage — Periods</h1>
        <p>Explore over 3,000 years of literature arranged by historical period. Data is loaded from <code>periods.json</code>.</p>
      </div>

      <div style="display:flex;gap:10px;align-items:center;">
        <div class="card" style="min-width:160px;padding:12px;text-align:center;">
          <div class="small-muted">Total periods</div>
          <div id="totalPeriods" style="font-weight:800;font-size:20px;margin-top:6px">—</div>
        </div>
        <div class="card" style="min-width:160px;padding:12px;text-align:center;">
          <div class="small-muted">Featured works</div>
          <div id="totalWorks" style="font-weight:800;font-size:20px;margin-top:6px">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main -->
  <main id="main-content">
    <div class="container">

      <div class="layout">

        <!-- LEFT: listing, controls, charts -->
        <section class="left-column">

          <!-- Controls card -->
          <div class="card" aria-labelledby="controlsTitle">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
              <div>
                <div id="controlsTitle" style="font-weight:800">Explore Periods</div>
                <div class="muted">Search, filter, sort, and paginate. Tap a period to open details.</div>
              </div>

              <div style="display:flex;gap:8px;align-items:center;">
                <button id="exportBtn" class="btn-ghost" title="Export current dataset">Export JSON</button>
                <button id="importBtn" class="btn-ghost" title="Import periods.json">Import JSON</button>
              </div>
            </div>

            <div class="controls" role="region" aria-label="Search and filters" style="margin-top:12px;">
              <input id="searchInput" type="search" placeholder="Search periods, works, themes..." aria-label="Search periods">
              <select id="regionFilter" aria-label="Filter by region">
                <option value="">All regions</option>
              </select>
              <select id="themeFilter" aria-label="Filter by theme">
                <option value="">All themes</option>
              </select>
              <select id="sortSelect" aria-label="Sort">
                <option value="start-desc">Start (new → old)</option>
                <option value="start-asc">Start (old → new)</option>
                <option value="name-asc">Name A → Z</option>
                <option value="name-desc">Name Z → A</option>
              </select>
              <select id="pageSize" aria-label="Items per page">
                <option value="4">4 / page</option>
                <option value="6" selected>6 / page</option>
                <option value="10">10 / page</option>
              </select>
              <button id="clearBtn" class="btn">Clear</button>
            </div>
          </div>

          <!-- Charts -->
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>Visual overview</strong>
              <div class="small-muted">Distribution & timeline</div>
            </div>

            <div class="charts-grid">
              <div>
                <canvas id="pieChart" style="width:100%;height:260px;"></canvas>
                <div class="small-muted" style="margin-top:6px;">Count by region</div>
              </div>
              <div>
                <canvas id="barChart" style="width:100%;height:260px;"></canvas>
                <div class="small-muted" style="margin-top:6px;">Start years (overview)</div>
              </div>
            </div>
          </div>

          <!-- Period list -->
          <div id="periodList" class="card" aria-live="polite">
            <!-- JS populates -->
            <div class="small-muted">Loading periods…</div>
          </div>

          <!-- Pagination -->
          <div id="pagination" class="pagination" role="navigation" aria-label="Pagination"></div>

        </section>

        <!-- RIGHT: detail + add form + recent -->
        <aside class="right-column">

          <!-- Detail panel -->
          <div class="card" aria-live="polite" id="detailPanel">
            <div class="detail-heading">
              <strong>Period details</strong>
              <div class="small-muted">Select a period</div>
            </div>
            <div class="detail-content" id="detailContent">
              <p class="muted">No period selected. Tap an item from the list to view details, recommended editions, and research notes.</p>
            </div>
          </div>

          <!-- Add period form (client-side only) -->
          <div class="card" style="margin-top:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>Add / Edit Period (local)</strong>
              <div class="small-muted">Client-side changes</div>
            </div>

            <form id="periodForm" style="margin-top:8px;" aria-label="Add or edit period">
              <div class="form-row" style="gap:8px;">
                <input id="formId" placeholder="id (slug e.g. medieval)" required>
                <input id="formName" placeholder="Name (e.g. Medieval Period)" required>
              </div>
              <div class="form-row" style="gap:8px;margin-top:8px;">
                <input id="formStart" placeholder="Start year (use negative for BCE)" type="number">
                <input id="formEnd" placeholder="End year" type="number">
              </div>
              <div class="form-row" style="gap:8px;margin-top:8px;">
                <input id="formRegion" placeholder="Region (e.g. Pan-Indian)">
                <input id="formLanguages" placeholder="Languages (comma separated)">
              </div>
              <div style="margin-top:8px;">
                <textarea id="formDescription" rows="3" placeholder="Short description"></textarea>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px;">
                <button id="savePeriod" type="button" class="btn">Save (add/update)</button>
                <button id="resetForm" type="button" class="btn-ghost">Reset</button>
              </div>
              <div class="small-muted" style="margin-top:8px;">Note: This add/edit operates in browser memory (and exportable JSON). To persist server-side, upload to your server or integrate a backend endpoint.</div>
            </form>
          </div>

          <!-- Recent / quick links -->
          <div class="card" style="margin-top:12px;">
            <strong>Recent & Quick Links</strong>
            <ul id="recentList" class="list-compact" style="margin-top:8px;">
              <!-- populated -->
            </ul>
          </div>

        </aside>

      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div class="container footer-inner">
      <div>
        <div style="font-weight:700;">Indian Literature Archive</div>
        <div class="small-muted">A non-profit initiative — preserving India's literary heritage</div>
      </div>
      <div style="text-align:right;">
        <div class="small-muted">© <span id="year"></span> Indian Literature Archive</div>
        <div style="margin-top:6px;"><a href="privacy.html">Privacy</a> · <a href="terms.html">Terms</a> · <a href="accessibility.html">Accessibility</a></div>
      </div>
    </div>
  </footer>

  <!-- Back to top -->
  <button id="backToTop" class="sr-only" aria-label="Back to top">Back to top</button>

  <!-- Script block: fetch periods.json, render UI, charts, search, pagination, import/export, add/edit -->
  <script>
    /*************************************************************************
     * periods.html - Responsive, accessible, and feature-rich page
     * Data source: periods.json (fetched). Also supports client-side add/edit
     * and export/import of JSON. Uses Chart.js for visualizations.
     *
     * Note: Client-side add/edit modifies in-memory dataset only. To persist,
     * perform server-side write or implement an API endpoint.
     *************************************************************************/

    // ---------- App State ----------
    const APP = {
      data: [],            // full dataset from periods.json or imported source
      filtered: [],        // after search/filter/sort
      pageSize: 6,
      currentPage: 1,
      searchQuery: '',
      regionFilter: '',
      themeFilter: '',
      sortKey: 'start-desc'
    };

    // ---------- DOM refs ----------
    const periodListEl = document.getElementById('periodList');
    const paginationEl = document.getElementById('pagination');
    const searchInput = document.getElementById('searchInput');
    const regionFilter = document.getElementById('regionFilter');
    const themeFilter = document.getElementById('themeFilter');
    const sortSelect = document.getElementById('sortSelect');
    const pageSizeSelect = document.getElementById('pageSize');
    const clearBtn = document.getElementById('clearBtn');
    const totalPeriods = document.getElementById('totalPeriods');
    const totalWorks = document.getElementById('totalWorks');
    const detailContent = document.getElementById('detailContent');
    const recentList = document.getElementById('recentList');

    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const periodForm = document.getElementById('periodForm');
    const savePeriodBtn = document.getElementById('savePeriod');
    const resetFormBtn = document.getElementById('resetForm');
    const formId = document.getElementById('formId');
    const formName = document.getElementById('formName');
    const formStart = document.getElementById('formStart');
    const formEnd = document.getElementById('formEnd');
    const formRegion = document.getElementById('formRegion');
    const formLanguages = document.getElementById('formLanguages');
    const formDescription = document.getElementById('formDescription');

    // Charts
    let pieChart = null;
    let barChart = null;
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    const barCtx = document.getElementById('barChart').getContext('2d');

    // ---------- Utility functions ----------
    function safe(str){ return str == null ? '' : String(str); }
    function escapeHtml(s){ return safe(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function debounce(fn,delay=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; }
    function downloadJSON(obj, filename='periods-export.json'){ const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    // ---------- Fetch source JSON ----------
    async function loadSource(url='periods.json'){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('Failed to fetch ' + url + ' ('+res.status+')');
        const json = await res.json();
        APP.data = Array.isArray(json.periods) ? json.periods.slice() : (Array.isArray(json) ? json.slice() : []);
        // ensure id uniqueness
        APP.data = APP.data.map(p => ({ id: safe(p.id) || slugify(p.name || 'period-'+Math.random().toString(36).slice(2,8)), ...p }));
        initializeFilters();
        applyTransforms();
        renderCharts();
        renderRecent();
        updateStats();
      }catch(err){
        periodListEl.innerHTML = '<div class="muted">Error loading periods.json: '+escapeHtml(err.message)+'</div>';
        console.error(err);
      }
    }

    // ---------- Initialization ----------
    function initializeFilters(){
      const regions = Array.from(new Set(APP.data.map(p => safe(p.region))).values()).filter(Boolean).sort();
      regionFilter.innerHTML = '<option value="">All regions</option>' + regions.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');
      const themes = new Set();
      APP.data.forEach(p => (p.themes||[]).forEach(t => themes.add(t)));
      const themeList = Array.from(themes).sort();
      themeFilter.innerHTML = '<option value="">All themes</option>' + themeList.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    }

    // ---------- Transform: search/filter/sort ----------
    function applyTransforms(){
      let arr = APP.data.slice();

      // search
      const q = APP.searchQuery.trim().toLowerCase();
      if(q){
        arr = arr.filter(p => {
          return (p.name && p.name.toLowerCase().includes(q)) ||
                 (p.description && p.description.toLowerCase().includes(q)) ||
                 ((p.keyWorks||[]).join(' ').toLowerCase().includes(q)) ||
                 ((p.themes||[]).join(' ').toLowerCase().includes(q));
        });
      }

      // region
      if(APP.regionFilter){
        arr = arr.filter(p => safe(p.region) === APP.regionFilter);
      }

      // theme
      if(APP.themeFilter){
        arr = arr.filter(p => (p.themes||[]).map(t => t.toLowerCase()).includes(APP.themeFilter.toLowerCase()));
      }

      // sort
      switch(APP.sortKey){
        case 'start-asc':
          arr.sort((a,b)=> (a.start||0) - (b.start||0)); break;
        case 'start-desc':
          arr.sort((a,b)=> (b.start||0) - (a.start||0)); break;
        case 'name-asc':
          arr.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); break;
        case 'name-desc':
          arr.sort((a,b)=> (b.name||'').localeCompare(a.name||'')); break;
        default:
          arr.sort((a,b)=> (b.start||0) - (a.start||0));
      }

      APP.filtered = arr;
      APP.currentPage = clamp(APP.currentPage,1,Math.max(1, Math.ceil(APP.filtered.length / APP.pageSize)));
      renderList();
      renderPagination();
    }

    // ---------- Render list & item ----------
    function renderList(){
      const start = (APP.currentPage - 1) * APP.pageSize;
      const pageItems = APP.filtered.slice(start, start + APP.pageSize);
      totalPeriods.textContent = APP.data.length;
      // compute total works (sum keyWorks lengths)
      const works = APP.data.reduce((s,p)=> s + ((p.keyWorks||[]).length), 0);
      totalWorks.textContent = works;

      if(pageItems.length === 0){
        periodListEl.innerHTML = '<div class="muted">No periods found for current filters.</div>';
        return;
      }

      periodListEl.innerHTML = pageItems.map(p => {
        const tags = (p.languages||[]).slice(0,4).map(l => `<span class="tag">${escapeHtml(l)}</span>`).join('');
        const keySnippet = (p.keyWorks||[]).slice(0,2).map(k => escapeHtml(k)).join('<br>');
        return `
          <article class="period-card" role="article" data-id="${escapeHtml(p.id)}" tabindex="0">
            <div class="period-title">
              <h3>${escapeHtml(p.name)}</h3>
              <div class="period-meta">${escapeHtml(p.start ?? '—')} – ${escapeHtml(p.end ?? '—')}</div>
            </div>
            <div class="muted" style="margin-top:8px;">${escapeHtml((p.description||'').slice(0,220))}${(p.description && p.description.length>220? '…':'')}</div>
            <div class="period-tags">${tags}</div>
            <table aria-hidden="false">
              <thead><tr><th>Key works</th><th>Manuscripts</th></tr></thead>
              <tbody><tr><td>${keySnippet || '—'}</td><td>${escapeHtml((p.stats && p.stats.manuscripts) || '—')}</td></tr></tbody>
            </table>
          </article>`;
      }).join('');

      // attach click/keyboard listeners
      periodListEl.querySelectorAll('.period-card').forEach(el=>{
        el.addEventListener('click', ()=> { const id=el.dataset.id; const rec = APP.data.find(x=>String(x.id)===String(id)); if(rec) showDetail(rec); });
        el.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' ') { e.preventDefault(); el.click(); } });
      });
    }

    // ---------- Pagination ----------
    function renderPagination(){
      const total = APP.filtered.length;
      const pages = Math.max(1, Math.ceil(total / APP.pageSize));
      const cur = APP.currentPage;
      const buttons = [];

      // helper to create button
      function btn(label, page, active=false){
        const b = document.createElement('button');
        b.textContent = label;
        if(active) b.classList.add('active');
        b.disabled = page === cur;
        b.addEventListener('click', ()=> { APP.currentPage = page; renderList(); renderPagination(); });
        return b;
      }

      paginationEl.innerHTML = '';

      // first & prev
      paginationEl.appendChild(btn('« First', 1));
      paginationEl.appendChild(btn('‹ Prev', Math.max(1, cur-1)));

      // numeric window
      const windowSize = 3;
      let start = Math.max(1, cur - windowSize);
      let end = Math.min(pages, cur + windowSize);
      if(start > 1){
        paginationEl.appendChild(btn('1',1));
        if(start > 2) paginationEl.appendChild(Object.assign(document.createElement('span'),{textContent:'…', style:'padding:8px 10px;color:var(--muted);'}));
      }
      for(let i=start;i<=end;i++){
        paginationEl.appendChild(btn(String(i), i, i===cur));
      }
      if(end < pages){
        if(end < pages-1) paginationEl.appendChild(Object.assign(document.createElement('span'),{textContent:'…', style:'padding:8px 10px;color:var(--muted);'}));
        paginationEl.appendChild(btn(String(pages), pages));
      }

      // next & last
      paginationEl.appendChild(btn('Next ›', Math.min(pages, cur+1)));
      paginationEl.appendChild(btn('Last »', pages));

      // summary
      const summary = document.createElement('div');
      summary.style.marginLeft='12px';
      summary.style.fontSize='13px';
      summary.style.color='var(--muted)';
      const from = (cur-1)*APP.pageSize + 1;
      const to = Math.min(total, cur*APP.pageSize);
      summary.textContent = `Showing ${total===0?0:from}-${to} of ${total}`;
      paginationEl.appendChild(summary);
    }

    // ---------- Detail rendering ----------
    function showDetail(p){
      detailContent.innerHTML = `
        <div>
          <h3 style="margin:0">${escapeHtml(p.name)}</h3>
          <div class="small-muted" style="margin-top:6px;">${escapeHtml(p.start ?? '—')} – ${escapeHtml(p.end ?? '—')} • ${escapeHtml(p.region || '—')}</div>
          <p style="margin-top:10px;">${escapeHtml(p.description || 'No description available.')}</p>
          <h4 style="margin-top:10px;">Key works</h4>
          <ul>${(p.keyWorks||[]).map(k=>`<li>${escapeHtml(k)}</li>`).join('') || '<li>—</li>'}</ul>
          <h4 style="margin-top:10px;">Recommended editions</h4>
          <ul>${(p.recommended||[]).map(r => `<li>${escapeHtml(r.title)}${r.edition ? ' — '+escapeHtml(r.edition): ''}${r.link ? ' — <a href="'+escapeHtml(r.link)+'" target="_blank" rel="noopener">view</a>':''}</li>`).join('') || '<li>—</li>'}</ul>
          <h4 style="margin-top:10px;">Research notes</h4>
          <p class="small-muted">${escapeHtml(p.researchNotes || '')}</p>
        </div>`;
      // scroll into view on small screens
      detailContent.scrollIntoView({behavior:'smooth', block:'nearest'});
    }

    // ---------- Charts ----------
    function renderCharts(){
      // Pie: count by region
      const counts = {};
      APP.data.forEach(p => counts[p.region || 'Unknown'] = (counts[p.region || 'Unknown'] || 0) + 1);
      const labels = Object.keys(counts);
      const values = labels.map(l => counts[l]);

      if(pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels, datasets:[{ data: values, backgroundColor: generatePalette(labels.length) }] },
        options: { responsive:true, plugins:{legend:{position:'bottom'}} }
      });

      // Bar: start years histogram (grouped)
      const starts = APP.data.map(p => Number(p.start || 0)).filter(n => !isNaN(n));
      // Create bins
      const binSize = Math.ceil((Math.max(...starts) - Math.min(...starts || [0])) / 8) || 50;
      const minS = Math.min(...starts);
      const bins = {};
      starts.forEach(s => {
        const b = Math.floor((s - minS) / binSize);
        bins[b] = (bins[b] || 0) + 1;
      });
      const binLabels = Object.keys(bins).map(i => {
        const startYear = minS + i*binSize;
        const endYear = startYear + binSize - 1;
        return `${startYear}–${endYear}`;
      });
      const binValues = Object.keys(bins).map(k => bins[k]);

      if(barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels: binLabels, datasets:[{ label:'Periods (start year bins)', data: binValues, backgroundColor: generatePalette(binLabels.length) }] },
        options: { responsive:true, plugins:{legend:{display:false}} }
      });
    }

    function generatePalette(n){
      const base = ['#0b6b6b','#11888a','#38b2ac','#6ee7b7','#ffd166','#ffa07a','#ff7f7f','#b58cff','#7fb3ff','#8bd3ff'];
      return Array.from({length:n}, (_,i) => base[i % base.length]);
    }

    // ---------- Recent list ----------
    function renderRecent(){
      const recent = APP.data.filter(p => p.recent).slice(0,6);
      if(recent.length===0){
        recentList.innerHTML = '<li class="muted">No recent additions</li>';
        return;
      }
      recentList.innerHTML = recent.map(r => `<li><a href="#" data-id="${escapeHtml(r.id)}">${escapeHtml(r.name)}</a></li>`).join('');
      recentList.querySelectorAll('a').forEach(a=>{
        a.addEventListener('click', (e)=>{ e.preventDefault(); const id=a.dataset.id; const rec = APP.data.find(x=>x.id===id); if(rec) showDetail(rec); });
      });
    }

    // ---------- Import / Export ----------
    exportBtn.addEventListener('click', ()=> {
      downloadJSON({ generated: new Date().toISOString(), periods: APP.data }, 'periods-export.json');
    });

    importBtn.addEventListener('click', ()=> {
      // Create file input
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.addEventListener('change', async e => {
        const file = e.target.files[0];
        if(!file) return;
        try{
          const txt = await file.text();
          const json = JSON.parse(txt);
          const imported = Array.isArray(json.periods)? json.periods : (Array.isArray(json)? json : []);
          if(!imported.length){ alert('No periods array found in JSON'); return; }
          // Merge: append new items and keep unique by id (overwrite if same id)
          const map = new Map(APP.data.map(p=>[p.id,p]));
          imported.forEach(p => map.set(p.id || p.name, p));
          APP.data = Array.from(map.values());
          initializeFilters();
          applyTransforms();
          renderCharts();
          renderRecent();
          updateStats();
          alert('Imported ' + imported.length + ' periods (merged).');
        }catch(err){
          alert('Failed to import JSON: ' + err.message);
        }
      });
      input.click();
    });

    // ---------- Add / Edit period (client-side) ----------
    savePeriodBtn.addEventListener('click', ()=>{
      const idVal = (formId.value || '').trim();
      const nameVal = (formName.value || '').trim();
      if(!idVal || !nameVal){ alert('Please provide id and name'); return; }
      const record = {
        id: idVal,
        name: nameVal,
        start: formStart.value ? Number(formStart.value) : null,
        end: formEnd.value ? Number(formEnd.value) : null,
        region: formRegion.value || '',
        languages: (formLanguages.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        description: formDescription.value || '',
        keyWorks: [],
        themes: [],
        stats: {},
        recommended: [],
        researchNotes: '',
        recent: true
      };
      // check existing
      const existingIndex = APP.data.findIndex(p => String(p.id) === String(record.id));
      if(existingIndex >= 0){
        // update
        APP.data[existingIndex] = { ...APP.data[existingIndex], ...record };
      } else {
        APP.data.push(record);
      }
      initializeFilters();
      applyTransforms();
      renderCharts();
      renderRecent();
      updateStats();
      alert('Saved to local dataset. Use Export to download JSON or send to server for persistence.');
      periodForm.reset();
    });

    resetFormBtn.addEventListener('click', ()=>{ periodForm.reset(); });

    // ---------- Controls wiring ----------
    searchInput.addEventListener('input', debounce(e => { APP.searchQuery = e.target.value; applyTransforms(); }, 300));
    regionFilter.addEventListener('change', e => { APP.regionFilter = e.target.value; applyTransforms(); });
    themeFilter.addEventListener('change', e => { APP.themeFilter = e.target.value; applyTransforms(); });
    sortSelect.addEventListener('change', e => { APP.sortKey = e.target.value; applyTransforms(); });
    pageSizeSelect.addEventListener('change', e => { APP.pageSize = Number(e.target.value); APP.currentPage = 1; applyTransforms(); });
    clearBtn.addEventListener('click', ()=> {
      searchInput.value = '';
      regionFilter.value = '';
      themeFilter.value = '';
      sortSelect.value = 'start-desc';
      pageSizeSelect.value = '6';
      APP.searchQuery=''; APP.regionFilter=''; APP.themeFilter=''; APP.sortKey='start-desc'; APP.pageSize=6;
      applyTransforms();
    });

    // ---------- Misc UI: mobile menu toggle ----------
    document.getElementById('mobileToggle').addEventListener('click', function(){
      const mm = document.getElementById('mobileMenu');
      const expanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', String(!expanded));
      mm.style.display = expanded ? 'none' : 'block';
    });

    // ---------- Utility: slugify ----------
    function slugify(s){ return safe(s).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

    // ---------- Update top stats ----------
    function updateStats(){ totalPeriods.textContent = APP.data.length; totalWorks.textContent = APP.data.reduce((acc,p)=>acc + ((p.keyWorks||[]).length),0); }

    // ---------- Initial load ----------
    loadSource('periods.json');

    // ---------- Year in footer ----------
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---------- Accessibility: keyboard shortcuts (optional) ----------
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){ e.preventDefault(); searchInput.focus(); }
    });

    // ---------- End script ----------
  </script>
</body>
</html>