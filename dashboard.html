<!doctype html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin Dashboard</title><link rel="stylesheet" href="style.css"></head>
<body>
<div class="container">
  <h2>Admin Dashboard</h2>
  <div id="userInfo"></div>

  <form id="addForm">
    <label>State:</label>
    <select id="stateSelect"></select><br/><br/>
    <label>Published Date:</label><input id="pubDate" type="date" required class="search"/><br/><br/>
    <input id="headline" placeholder="Headline" required class="search"/><br/><br/>
    <textarea id="details" placeholder="Details" rows="6" style="width:100%"></textarea><br/><br/>
    <button>Add Current Affair</button>
  </form>

  <hr/>
  <div id="log"></div>
</div>

<script type="module">
  import { supabase } from 'supabase-client.js';

  const { data: { user }, error: userErr } = await supabase.auth.getUser();
  if (!user) { location.href = '/admin/login.html'; throw new Error('not logged in'); }
  document.getElementById('userInfo').innerText = `Logged in as ${user.email}`;

  // populate states
  const { data: states } = await supabase.from('states').select('name_en').order('name_en');
  const sel = document.getElementById('stateSelect');
  states.forEach(s => sel.innerHTML += `<option value="${s.name_en}">${s.name_en}</option>`);

  document.getElementById('addForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
      state_name: sel.value,
      headline: document.getElementById('headline').value,
      details: document.getElementById('details').value,
      published_date: document.getElementById('pubDate').value || new Date().toISOString().slice(0,10)
    };
    const { error } = await supabase.from('current_affairs').insert(payload);
    if (error) {
      document.getElementById('log').innerText = 'Error: '+error.message;
    } else {
      document.getElementById('log').innerText = 'Inserted successfully';
      document.getElementById('addForm').reset();
    }
  });
</script>
</body>
</html>